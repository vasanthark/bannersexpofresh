<?xml version="1.0" encoding="UTF-8"?>
<modification>
	<id>Bas5Builder - Admin Theme Engine</id>
	<version>1.0b</version>
	<vqmver>2.4.0</vqmver>
	<author>base5builder.com</author>
	<file name="admin/view/template/b5b_qore_engine/themes/*/*/template/common/header.tpl">
		<!-- Adds the javascript file to the header of other themes when on the QoreEngine page -->
		<operation error="skip">
			<search position="after"><![CDATA[
				<script src="view/template/b5b_qore_engine/themes/<?php echo $b5b_qore_engine_active_theme_path; ?>/plugins/jquery/jquery.min.js"></script>
				]]></search>
			<add><![CDATA[
				<!-- QoreEngine -->
				<script src="view/template/b5b_qore_engine/assets/js/script.js"></script>
				]]></add>
		</operation>
	</file>
	<file name="admin/view/template/common/header.tpl">
		<!-- Adds the javascript file to the header of the default theme when on the QoreEngine page -->
		<operation error="skip">
			<search position="after"><![CDATA[
				<script src="view/javascript/common.js" type="text/javascript"></script>
				]]></search>
			<add><![CDATA[
				<!-- QoreEngine -->
				<script src="view/template/b5b_qore_engine/assets/js/script.js"></script>
				<link type="text/css" href="view/template/b5b_qore_engine/assets/css/default_opencart_theme.css" rel="stylesheet" media="screen" />
				]]></add>
		</operation>
	</file>
	<file name="admin/controller/common/footer.php">
		<!-- Adds the $logged variable to the footer -->
		<operation error="skip">
			<search position="after"><![CDATA[
				$this->load->language('common/footer');
				]]></search>
			<add><![CDATA[
				if (!isset($this->request->get['token']) || !isset($this->session->data['token']) || ($this->request->get['token'] != $this->session->data['token'])) {
					$data['logged'] = '';
				}else{
					$data['logged'] = TRUE;
				}
				]]></add>
		</operation>
	</file>
	<!-- Adds Language Text -->
	<file name="admin/controller/*/*.php,admin/controller/*/*/*.php">
		<operation error="skip">
			<search position="after"><![CDATA[
				public function
				]]></search>
			<add><![CDATA[
				$this->load->language('b5b_qore_engine/general/general');

				$data['b5b_qore_engine']['language']['error_incompatible_version'] = $this->language->get('error_incompatible_version');
				$data['b5b_qore_engine']['language']['text_base5builder'] = $this->language->get('text_base5builder');
				$data['b5b_qore_engine']['language']['text_base5builder_support'] = $this->language->get('text_base5builder_support');
				]]></add>
		</operation>
	</file>
	<!-- Gets the currently active admin theme and stores it in a variable -->
	<file name="admin/controller/*/*.php,admin/controller/*/*/*.php">
		<operation error="skip">
			<search position="before"><![CDATA[
				return $this->load->view
				]]></search>
			<add><![CDATA[

				$this->load->model('b5b_qore_engine/general/settings');

				$table_exists = $this->model_b5b_qore_engine_general_settings->tableExsits('b5b_qore_engine_settings');

				if($table_exists){
					if(isset($this->request->get['route'])){
						$data['b5b_qore_engine_route'] = $this->request->get['route'];
					}else{
						$data['b5b_qore_engine_route'] = '';
					}

					$data['b5b_qore_engine_is_admin'] = 1;
					$data['b5b_qore_engine_active_theme'] = $this->model_b5b_qore_engine_general_settings->getSettings('active_theme');

					$info_path = DIR_TEMPLATE . 'b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/info.xml';

					if(file_exists($info_path)){
						$xml = simplexml_load_file($info_path);
						$data['b5b_qore_engine_active_theme_version'] = (string)$xml->version;
					}else{
						$data['b5b_qore_engine_active_theme_version'] = "";
					}
				}

				]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
				$this->response->setOutput($this->load->view
				]]></search>
			<add><![CDATA[

				$this->load->model('b5b_qore_engine/general/settings');

				$table_exists = $this->model_b5b_qore_engine_general_settings->tableExsits('b5b_qore_engine_settings');

				if($table_exists){

					if(isset($this->request->get['route'])){
						$data['b5b_qore_engine_route'] = $this->request->get['route'];
					}else{
						$data['b5b_qore_engine_route'] = '';
					}

					$data['b5b_qore_engine_is_admin'] = 1;
					$data['b5b_qore_engine_active_theme'] = $this->model_b5b_qore_engine_general_settings->getSettings('active_theme');

					$info_path = DIR_TEMPLATE . 'b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/info.xml';

					if(file_exists($info_path)){
						$xml = simplexml_load_file($info_path);
						$data['b5b_qore_engine_active_theme_version'] = (string)$xml->version;
					}
				}

				]]></add>
		</operation>
	</file>
	<!-- Adds the fallback option for the admin theme -->
	<!-- MUST BE PLACED LAST -->
	<file name="system/engine/loader.php">
		<!-- DO NOT DELETE - START -->
		<operation error="skip">
			<search position="replace"><![CDATA[
				public function view
				]]></search>
			<add><![CDATA[
				public function view($route, $data = array()) {
					$opencart_version = (int)str_replace('.', '', VERSION); // stringyfied

					if($opencart_version >= 2100 && $opencart_version < 2200){

						$template = $route; // DO NOT DELETE

						// Checks if "load" method is being called from the admin
						if((isset($data['b5b_qore_engine_is_admin'])) && ($data['b5b_qore_engine_is_admin'] == 1)){

							if(file_exists(DIR_TEMPLATE . '/b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/user_override/template/' . $template)){

								// Adds the additional 'user_override' to the path for use in tpl files
								$data['b5b_qore_engine_active_theme_path'] = $data['b5b_qore_engine_active_theme'] . '/user_override';

								extract($data);

								ob_start();

								$file = DIR_TEMPLATE . 'b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/user_override/template/' . $template;

								require(modification($file));

							}elseif(file_exists(DIR_TEMPLATE . '/b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/default/template/' . $template)){

								// Adds the additional 'user_override' to the path for use in tpl files
								$data['b5b_qore_engine_active_theme_path'] = $data['b5b_qore_engine_active_theme'] . '/default';

								extract($data);

								ob_start();

								$file = DIR_TEMPLATE . 'b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/default/template/' . $template;

								require(modification($file));

							}else{

								extract($data);

								ob_start();
								
								$file = DIR_TEMPLATE . $template;

								require(modification($file));

							}

							$output = ob_get_contents();

							ob_end_clean();

						}else{
							$file = DIR_TEMPLATE . $template;

							if(file_exists($file)){
								extract($data);

								ob_start();

								require(modification($file));

								$output = ob_get_contents();

								ob_end_clean();
							}else{
								trigger_error('Error: Could not load template ' . $file . '!');
								exit();
							}

						}

						return $output;

					}else if($opencart_version >= 2200 && $opencart_version < 2300){
						// Sanitize the call
						$route = str_replace('../', '', (string)$route);
						
						// Trigger the pre events
						$result = $this->registry->get('event')->trigger('view/' . $route . '/before', array(&$route, &$data));
						
						if ($result) {
							return $result;
						}
						
						$template = new Template('basic');
						
						// Checks if "load" method is being called from the admin
						if((isset($data['b5b_qore_engine_is_admin'])) && ($data['b5b_qore_engine_is_admin'] == 1)){

							if(file_exists(DIR_TEMPLATE . '/b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/user_override/template/' . $route . '.tpl')){

								// Adds the additional 'user_override' to the path for use in tpl files
								$data['b5b_qore_engine_active_theme_path'] = $data['b5b_qore_engine_active_theme'] . '/user_override';

								foreach ($data as $key => $value) {
									$template->set($key, $value);
								}

								$output = $template->render('b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/user_override/template/' . $route . '.tpl');

							}elseif(file_exists(DIR_TEMPLATE . '/b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/default/template/' . $route . '.tpl')){

								// Adds the additional 'user_override' to the path for use in tpl files
								$data['b5b_qore_engine_active_theme_path'] = $data['b5b_qore_engine_active_theme'] . '/default';

								foreach ($data as $key => $value) {
									$template->set($key, $value);
								}

								$output = $template->render('b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/default/template/' . $route . '.tpl');

							}else{

								foreach ($data as $key => $value) {
									$template->set($key, $value);
								}

								$output = $template->render($route . '.tpl');

							}
						}else{

							foreach ($data as $key => $value) {
								$template->set($key, $value);
							}
							$output = $template->render($route . '.tpl');

						}
						
						// Trigger the post e
						$result = $this->registry->get('event')->trigger('view/' . $route . '/after', array(&$route, &$data, &$output));
						
						if ($result) {
							return $result;
						}
						
						return $output;

					}else if($opencart_version >= 2300){
						$output = null;
						
						// Sanitize the call
						$route = preg_replace('/[^a-zA-Z0-9_\/]/', '', (string)$route);
						
						// Trigger the pre events
						$result = $this->registry->get('event')->trigger('view/' . $route . '/before', array(&$route, &$data, &$output));
						
						if ($result) {
							return $result;
						}


						if (!$output) {
							$template = new Template($this->registry->get('config')->get('template_type'));

							// Checks if "load" method is being called from the admin
							if((isset($data['b5b_qore_engine_is_admin'])) && ($data['b5b_qore_engine_is_admin'] == 1)){

								if(file_exists(DIR_TEMPLATE . '/b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/user_override/template/' . $route . '.tpl')){

									// Adds the additional 'user_override' to the path for use in tpl files
									$data['b5b_qore_engine_active_theme_path'] = $data['b5b_qore_engine_active_theme'] . '/user_override';

									foreach ($data as $key => $value) {
										$template->set($key, $value);
									}

									$output = $template->render('b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/user_override/template/' . $route . '.tpl');

								}elseif(file_exists(DIR_TEMPLATE . '/b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/default/template/' . $route . '.tpl')){

									// Adds the additional 'user_override' to the path for use in tpl files
									$data['b5b_qore_engine_active_theme_path'] = $data['b5b_qore_engine_active_theme'] . '/default';

									foreach ($data as $key => $value) {
										$template->set($key, $value);
									}

									$output = $template->render('b5b_qore_engine/themes/' . $data['b5b_qore_engine_active_theme'] . '/default/template/' . $route . '.tpl');

								}else{

									foreach ($data as $key => $value) {
										$template->set($key, $value);
									}

									$output = $template->render($route . '.tpl');

								}
							}else{

								foreach ($data as $key => $value) {
									$template->set($key, $value);
								}
								$output = $template->render($route . '.tpl');

							}
						}
						
						// Trigger the post events
						$result = $this->registry->get('event')->trigger('view/' . $route . '/after', array(&$route, &$data, &$output));
						
						if ($result) {
							return $result;
						}
						
						return $output;
					}
				}

				public function view_old]]></add>
		</operation>
		<!-- DO NOT DELETE - END -->
	</file>
</modification>
